# Global variables - these are additive with included pipeline vars
.models:
  - MODEL:
    - nvidia/comfy-ui
    - nvidia/connect-to-your-spark
    - nvidia/cuda-x-data-science
    - nvidia/dgx-dashboard
    - nvidia/flux-finetuning
    - nvidia/jax
    - nvidia/llama-factory
    - nvidia/multi-agent-chatbot
    - nvidia/multi-modal-inference
    - nvidia/nccl
    - nvidia/nemo-fine-tune
    - nvidia/nim-llm
    - nvidia/nvfp4-quantization
    - nvidia/open-webui
    - nvidia/pytorch-fine-tune
    - nvidia/rag-ai-workbench
    - nvidia/speculative-decoding
    - nvidia/connect-two-sparks
    - nvidia/tailscale
    - nvidia/trt-llm
    - nvidia/txt2kg
    - nvidia/unsloth
    - nvidia/vibe-coding
    - nvidia/vllm
    - nvidia/vlm-finetuning
    - nvidia/vscode
    - nvidia/vss

variables:
  # Base URLs used for substitution in ux-conf.yaml
  GITLAB_ASSET_BASEURL: "https://github.com/NVIDIA/dgx-spark-playbooks/blob/main"
  GITLAB_REPO_BASEURL: "https://github.com/NVIDIA/dgx-spark-playbooks"

  # Source repository for assets (internal GitLab)
  SRC_ASSETS_URL: "https://gitlab-master.nvidia.com/spark-playbooks/dgx-spark-playbook-assets.git"
  
  # Destination repositories (JSON array format for parsing in script)
  # Cutover to Github.com supported via the public_github alias
  # Format: [{"alias": "name", "url": "git-url", "token_var": "ENV_VAR_NAME"}, ...]


  #### This is a test
  #### Gitlab Only Publishing: 
  DST_REPOS_JSON: '[{"alias":"public_gitlab","url":"https://gitlab.com/nvidia/dgx-spark/temp-external-playbook-assets/dgx-spark-playbook-assets","token_var":"GITLAB_TOKEN_DGX_SPARK_PLAYBOOKS"}]'

  #### This is production
  #### DST_REPOS_JSON: '[{"alias":"public_gitlab","url":"https://gitlab.com/nvidia/dgx-spark/temp-external-playbook-assets/dgx-spark-playbook-assets","token_var":"GITLAB_TOKEN_DGX_SPARK_PLAYBOOKS"}, {"alias":"public_github","url":"git@github.com:NVIDIA/dgx-spark-playbooks.git","token_var":"GITHUB_TOKEN_DGX_SPARK_PLAYBOOKS"}]'

  
  # Forbidden reference patterns (regex) - blocks internal references in public docs
  # Job will FAIL if these patterns are detected in generated markdown
  # Override in GitLab UI if needed: Settings > CI/CD > Variables
  FORBIDDEN_PATTERNS_JSON: '["sw-docs-dgx-station","gitlab-master\\.nvidia\\.com","urm\\.nvidia\\.com"]'
  
  # Root files to copy from source assets repo (glob patterns)
  # These files are copied from source assets repo root to each destination repo root
  ROOT_FILE_GLOBS_JSON: '["LICENSE*","CONTRIBUTING.md","CODE_OF_CONDUCT.md"]'
  
  # Root directories to copy from project root (directory names)
  # These directories are copied from CI project root to each destination repo root
  # Used for images and assets referenced in README-Public.md
  ROOT_DIRS_JSON: '["src"]'

  # Models to skip from publication to Github/Gitlab (this does not affect build.nvidia.com publication)
  SKIP_MODELS_JSON: '["nvidia/monai-reasoning", "nvidia/protein-folding", "nvidia/sglang"]'

# Step 2: Aggregate all models and publish to public repos (single push, complete regeneration)
custom:publish-all-playbooks:
  stage: launch_ux_prd
  image: 
    name: gitlab-master.nvidia.com:5005/api-catalog/pipeline:latest
    entrypoint: [""]
  before_script:
    #- apt-get update && apt-get install -y openssh-client
    - git config --global user.email "automaton@nvidia.com"
    - git config --global user.name "GitLab CI"
    # Setup SSH for GitHub deploy key
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - cat "$GITHUB_TOKEN_DGX_SPARK_PLAYBOOKS" > ~/.ssh/github_deploy_key
    - chmod 600 ~/.ssh/github_deploy_key
    # Ensure key ends with newline and check format
    - echo "" >> ~/.ssh/github_deploy_key
    - head -1 ~/.ssh/github_deploy_key
    - ssh-keygen -y -f ~/.ssh/github_deploy_key > /dev/null || (echo "âŒ Invalid key format" && exit 1)
    - |
      cat > ~/.ssh/config <<EOF
      Host github.com
        HostName github.com
        User git
        IdentityFile ~/.ssh/github_deploy_key
        StrictHostKeyChecking no
        UserKnownHostsFile=/dev/null
      EOF
    - chmod 600 ~/.ssh/config
    - ssh -T git@github.com || echo "SSH configured (exit code $? is expected)"
  script:
    - echo "ðŸ“¦ Publishing all playbooks to public repositories..."
    # This is test without pushing to remote repositories
    - python -u scripts/publish_all_playbooks.py --artifacts-dir convergence-output --allow-forbidden-refs --censor-forbidden-refs
    # This is the production command
    # - python -u scripts/publish_all_playbooks.py --artifacts-dir convergence-output --push --allow-forbidden-refs --censor-forbidden-refs
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
  allow_failure: false

